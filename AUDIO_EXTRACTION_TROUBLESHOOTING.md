# ğŸ”§ éŸ³é¢‘æå–å¤±è´¥æ•…éšœæ’æŸ¥æŒ‡å—

## æŸ¥çœ‹è°ƒè¯•æ—¥å¿—

æˆ‘å·²ç»åœ¨ä»£ç ä¸­æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºã€‚è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æŸ¥çœ‹ï¼š

### 1. åœ¨ç»ˆç«¯æŸ¥çœ‹æ—¥å¿—

è¿è¡Œåº”ç”¨æ—¶ï¼Œåœ¨ç»ˆç«¯ä¸­ä¼šçœ‹åˆ°è¿™äº›æ—¥å¿—ï¼š

```
ğŸ¬ å¼€å§‹æå–éŸ³é¢‘...
ğŸ“¹ è§†é¢‘è·¯å¾„: /path/to/video.mp4
ğŸµ éŸ³é¢‘è·¯å¾„: /path/to/audio.mp3
âš™ï¸ FFmpegå‘½ä»¤: -i "/path/to/video.mp4" -vn -ar 44100 -ac 2 -b:a 192k -y "/path/to/audio.mp3"
ğŸ” FFmpeg è¿”å›ç : xxx
ğŸ“ FFmpeg è¾“å‡ºæ—¥å¿—:
...
```

### 2. æŸ¥çœ‹åº”ç”¨å†…é”™è¯¯æç¤º

æå–å¤±è´¥æ—¶ï¼Œåº”ç”¨ä¼šæ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- FFmpeg é”™è¯¯ç 
- å…³é”®é”™è¯¯æ—¥å¿—
- æ–‡ä»¶è·¯å¾„ä¿¡æ¯

## å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: MissingPluginException

**é”™è¯¯ä¿¡æ¯ï¼š**
```
MissingPluginException(No implementation found for method...)
```

**åŸå› ï¼š** FFmpeg æ’ä»¶æœªæ­£ç¡®æ³¨å†Œ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. å®Œå…¨åœæ­¢åº”ç”¨
# 2. æ¸…ç†é¡¹ç›®
flutter clean

# 3. é‡æ–°è·å–ä¾èµ–
flutter pub get

# 4. å®Œå…¨é‡å¯åº”ç”¨ï¼ˆä¸è¦ç”¨çƒ­é‡è½½ï¼‰
flutter run
```

### é—®é¢˜ 2: è§†é¢‘æ–‡ä»¶è·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦

**é”™è¯¯ä¿¡æ¯ï¼š**
```
No such file or directory
```

**åŸå› ï¼š** æ–‡ä»¶è·¯å¾„åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦

**è§£å†³æ–¹æ¡ˆï¼š**
å·²åœ¨ä»£ç ä¸­ç”¨åŒå¼•å·åŒ…è£¹è·¯å¾„ï¼š
```dart
final command = '-i "$videoPath" -vn -ar 44100 -ac 2 -b:a 192k -y "$audioPath"';
```

å¦‚æœä»ç„¶å¤±è´¥ï¼Œæ£€æŸ¥è§†é¢‘æ–‡ä»¶åæ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚

### é—®é¢˜ 3: è§†é¢‘ç¼–ç æ ¼å¼ä¸æ”¯æŒ

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Invalid data found when processing input
Unsupported codec
```

**åŸå› ï¼š** è§†é¢‘ç¼–ç æ ¼å¼ FFmpeg ä¸æ”¯æŒ

**è§£å†³æ–¹æ¡ˆï¼š**
å°è¯•ä½¿ç”¨æ›´é€šç”¨çš„æå–å‘½ä»¤ï¼š
```dart
// ç®€åŒ–ç‰ˆå‘½ä»¤ï¼Œè‡ªåŠ¨æ£€æµ‹éŸ³é¢‘æµ
final command = '-i "$videoPath" -vn -acodec libmp3lame -y "$audioPath"';

// æˆ–è€…ç›´æ¥å¤åˆ¶éŸ³é¢‘æµï¼ˆæœ€å¿«ï¼Œä½†å¯èƒ½ä¸å…¼å®¹ï¼‰
final command = '-i "$videoPath" -vn -acodec copy -y "$audioPath"';
```

### é—®é¢˜ 4: è¾“å‡ºç›®å½•æƒé™é—®é¢˜

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Permission denied
Cannot write to output file
```

**åŸå› ï¼š** åº”ç”¨å¯¹è¾“å‡ºç›®å½•æ²¡æœ‰å†™æƒé™

**è§£å†³æ–¹æ¡ˆï¼š**

#### Android:
æ£€æŸ¥ `AndroidManifest.xml` æƒé™ï¼š
```xml
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
```

åœ¨è¿è¡Œæ—¶è¯·æ±‚æƒé™ï¼š
```dart
import 'package:permission_handler/permission_handler.dart';

// è¯·æ±‚å­˜å‚¨æƒé™
await Permission.storage.request();
```

#### iOS:
æ£€æŸ¥ `Info.plist` æƒé™ï¼š
```xml
<key>NSPhotoLibraryUsageDescription</key>
<string>éœ€è¦è®¿é—®ç›¸å†Œ</string>
```

### é—®é¢˜ 5: æ–‡ä»¶é€‰æ‹©å™¨è¿”å›ç©ºè·¯å¾„

**é”™è¯¯ä¿¡æ¯ï¼š**
```
âŒ æ— æ³•è·å–è§†é¢‘è·¯å¾„
```

**åŸå› ï¼š**
- ç”¨æˆ·å–æ¶ˆé€‰æ‹©
- FilePicker æ— æ³•è®¿é—®æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
ç¡®ä¿æƒé™å·²æˆäºˆï¼Œå¹¶ä¸”ä»æ”¯æŒçš„ä½ç½®é€‰æ‹©æ–‡ä»¶ã€‚

### é—®é¢˜ 6: éŸ³é¢‘æµä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Stream specifier ':a' in filtergraph description
Output file does not contain any stream
```

**åŸå› ï¼š** è§†é¢‘æ–‡ä»¶ä¸­æ²¡æœ‰éŸ³é¢‘æµ

**è§£å†³æ–¹æ¡ˆï¼š**

ä¿®æ”¹ä»£ç æ£€æŸ¥éŸ³é¢‘æµï¼š
```dart
// å…ˆæ£€æŸ¥è§†é¢‘æ˜¯å¦æœ‰éŸ³é¢‘æµ
final checkCommand = '-i "$videoPath" 2>&1';
// ç„¶åæ ¹æ®æ£€æŸ¥ç»“æœå†³å®šæ˜¯å¦æå–
```

### é—®é¢˜ 7: FFmpeg è¶…æ—¶

**é”™è¯¯ä¿¡æ¯ï¼š**
å¤„ç†ä¸€ç›´åœ¨è¿›è¡Œï¼Œä½†ä»ä¸å®Œæˆ

**åŸå› ï¼š**
- è§†é¢‘æ–‡ä»¶å¤ªå¤§
- è®¾å¤‡æ€§èƒ½ä¸è¶³

**è§£å†³æ–¹æ¡ˆï¼š**

1. é™åˆ¶è§†é¢‘å¤§å°ï¼š
```dart
// æ£€æŸ¥æ–‡ä»¶å¤§å°
if (videoFileSize > 500 * 1024 * 1024) { // 500 MB
  // æç¤ºç”¨æˆ·æ–‡ä»¶å¤ªå¤§
  return;
}
```

2. æ·»åŠ è¶…æ—¶å¤„ç†ï¼š
```dart
await FFmpegKit.execute(command).timeout(
  const Duration(minutes: 5),
  onTimeout: () {
    print('âŒ æå–è¶…æ—¶');
    return null;
  },
);
```

## è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥ FFmpeg æ˜¯å¦æ­£å¸¸å·¥ä½œ

åœ¨ `initState` ä¸­æ·»åŠ æµ‹è¯•ï¼š
```dart
Future<void> _testFFmpeg() async {
  try {
    await FFmpegKit.execute('-version').then((session) async {
      final logs = await session.getOutput();
      print('FFmpeg ç‰ˆæœ¬ä¿¡æ¯:');
      print(logs);
    });
  } catch (e) {
    print('âŒ FFmpeg æµ‹è¯•å¤±è´¥: $e');
  }
}
```

### æ­¥éª¤ 2: æµ‹è¯•ç®€å•çš„éŸ³é¢‘æå–

ä½¿ç”¨æœ€ç®€å•çš„å‘½ä»¤ï¼š
```dart
final command = '-i "$videoPath" "$audioPath"';
```

å¦‚æœæˆåŠŸï¼Œé€æ­¥æ·»åŠ å‚æ•°ï¼š
```dart
// ç¬¬ä¸€æ­¥ï¼šåªæŒ‡å®šè¾“å‡ºæ ¼å¼
final command = '-i "$videoPath" -f mp3 "$audioPath"';

// ç¬¬äºŒæ­¥ï¼šæ·»åŠ éŸ³é¢‘ç¼–ç 
final command = '-i "$videoPath" -f mp3 -acodec libmp3lame "$audioPath"';

// ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ å®Œæ•´å‚æ•°
final command = '-i "$videoPath" -vn -ar 44100 -ac 2 -b:a 192k "$audioPath"';
```

### æ­¥éª¤ 3: æ£€æŸ¥æ–‡ä»¶è·¯å¾„

æ·»åŠ è·¯å¾„éªŒè¯ï¼š
```dart
print('è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨: ${await File(videoPath).exists()}');
print('è¾“å‡ºç›®å½•æ˜¯å¦å­˜åœ¨: ${await Directory(audioDir.path).exists()}');
print('è¾“å‡ºç›®å½•æƒé™: ${await _checkDirectoryPermission(audioDir.path)}');
```

### æ­¥éª¤ 4: æŸ¥çœ‹å®Œæ•´çš„ FFmpeg æ—¥å¿—

æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—å†…å®¹ï¼ˆä¸è¦åªçœ‹é”™è¯¯ï¼‰ï¼š
```dart
final allLogs = await session.getAllLogsAsString();
print('å®Œæ•´æ—¥å¿—ï¼š');
print(allLogs);
```

## ä½¿ç”¨ç®€åŒ–ç‰ˆå‘½ä»¤ï¼ˆæ¨èç”¨äºè°ƒè¯•ï¼‰

å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•è¿™ä¸ªæœ€ç®€å•çš„ç‰ˆæœ¬ï¼š

```dart
// æœ€ç®€å•çš„éŸ³é¢‘æå–å‘½ä»¤
final command = '-i "$videoPath" -vn -c:a copy "$audioPath"';

// å¦‚æœä¸Šé¢å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶ç¼–ç 
final command = '-i "$videoPath" -vn -c:a libmp3lame -q:a 2 "$audioPath"';
```

## å¹³å°ç‰¹å®šé—®é¢˜

### Android ç‰¹æœ‰é—®é¢˜

1. **API 30+ å­˜å‚¨é™åˆ¶**
   - ä½¿ç”¨ Scoped Storage
   - é€‰æ‹©æ–‡ä»¶æ—¶ï¼ŒFilePicker è¿”å›çš„å¯èƒ½æ˜¯å†…å®¹ URI

2. **è§£å†³æ–¹æ¡ˆï¼š** å¤åˆ¶æ–‡ä»¶åˆ°åº”ç”¨ç§æœ‰ç›®å½•
```dart
// å¤åˆ¶è§†é¢‘åˆ°ä¸´æ—¶ç›®å½•
final tempDir = await getTemporaryDirectory();
final tempVideoPath = '${tempDir.path}/temp_video.mp4';
await File(videoPath).copy(tempVideoPath);

// ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æå–
final command = '-i "$tempVideoPath" -vn "$audioPath"';
```

### iOS ç‰¹æœ‰é—®é¢˜

1. **Photo Library æƒé™**
   - ç¡®ä¿ Info.plist æœ‰æ­£ç¡®çš„æƒé™æè¿°
   - ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨æ—¶å¿…é¡»æˆäºˆæƒé™

2. **æ–‡ä»¶è®¿é—®é™åˆ¶**
   - iOS æ²™ç›’é™åˆ¶æ–‡ä»¶è®¿é—®
   - ç¡®ä¿ä½¿ç”¨åº”ç”¨æ²™ç›’å†…çš„è·¯å¾„

## ç°åœ¨è¿è¡Œå¹¶æŸ¥çœ‹æ—¥å¿—

### è¿è¡Œåº”ç”¨ï¼š
```bash
flutter run
```

### æ“ä½œæ­¥éª¤ï¼š
1. ç‚¹å‡» "é€‰æ‹©è§†é¢‘æå–éŸ³é¢‘"
2. é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶
3. **æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºçš„è¯¦ç»†æ—¥å¿—**
4. **æŸ¥çœ‹åº”ç”¨å†…çš„é”™è¯¯æç¤º**

### æä¾›ç»™æˆ‘çš„ä¿¡æ¯ï¼š

è¯·å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶ç»™æˆ‘ï¼š

1. **ç»ˆç«¯æ—¥å¿—**ï¼ˆä» `ğŸ¬ å¼€å§‹æå–éŸ³é¢‘...` å¼€å§‹çš„æ‰€æœ‰å†…å®¹ï¼‰
2. **åº”ç”¨å†…æ˜¾ç¤ºçš„é”™è¯¯ä¿¡æ¯**
3. **è¿è¡Œå¹³å°**ï¼ˆAndroid/iOSï¼‰
4. **è§†é¢‘æ–‡ä»¶ä¿¡æ¯**ï¼ˆæ ¼å¼ã€å¤§å°ï¼‰

## å¿«é€Ÿæµ‹è¯•æ¸…å•

- [ ] FFmpeg æ’ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…ï¼Ÿè¿è¡Œ `flutter pub get`
- [ ] åº”ç”¨æ˜¯å¦å®Œå…¨é‡å¯ï¼Ÿï¼ˆä¸æ˜¯çƒ­é‡è½½ï¼‰
- [ ] æ˜¯å¦æˆäºˆäº†æ–‡ä»¶è®¿é—®æƒé™ï¼Ÿ
- [ ] è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è®¿é—®ï¼Ÿ
- [ ] è¾“å‡ºç›®å½•æ˜¯å¦æœ‰å†™æƒé™ï¼Ÿ
- [ ] æŸ¥çœ‹äº†ç»ˆç«¯çš„å®Œæ•´æ—¥å¿—ï¼Ÿ
- [ ] è§†é¢‘æ–‡ä»¶æ˜¯å¦å¤ªå¤§ï¼Ÿï¼ˆå»ºè®® < 100MB æµ‹è¯•ï¼‰
- [ ] è§†é¢‘æ–‡ä»¶æ˜¯å¦åŒ…å«éŸ³é¢‘æµï¼Ÿ

## æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœ FFmpeg ä¸€ç›´æœ‰é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **ä½¿ç”¨ ffmpeg_kit_flutter (å®˜æ–¹åŒ…)**
```yaml
dependencies:
  ffmpeg_kit_flutter: ^6.0.3
```

2. **ä½¿ç”¨ flutter_ffmpeg (æ—§ç‰ˆä½†ç¨³å®š)**
```yaml
dependencies:
  flutter_ffmpeg: ^0.4.2
```

---

**ä¸‹ä¸€æ­¥ï¼š** è¿è¡Œåº”ç”¨ï¼Œé€‰æ‹©è§†é¢‘æå–ï¼Œç„¶åæŠŠç»ˆç«¯æ—¥å¿—å‘ç»™æˆ‘ï¼
